{% extends 'base.html' %}

{% block content %}
<div class="row g-4">
    <!-- Sidebar -->
    <div class="col-lg-3 col-md-4">
        <div class="sidebar fade-up">
            <div class="sidebar-header">
                <a href="/sheet/{{ sheet_name }}" class="btn btn-outline-secondary btn-sm">&larr; Back</a>
                <span class="sidebar-title">Items</span>
            </div>
            <div class="list-group list-group-flush">
            {% for item in items %}
            <a href="/annotate/{{ sheet_name }}/{{ item.id }}"
                class="list-group-item list-group-item-action {{ 'active' if item.id == item_id else '' }}">
                <div class="d-flex w-100 justify-content-between">
                    <span class="text-truncate" style="max-width: 85%;">{{ item.id }}</span>
                    {% if item.status == 'Annotated' %}
                    <span class="text-success">&check;</span>
                    {% endif %}
                </div>
            </a>
            {% endfor %}
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="col-lg-9 col-md-8">
        <div class="card mb-4 annotate-toolbar fade-up">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="card-title">
                        ID: {{ item_id }}
                        <a href="/help" target="_blank" class="text-decoration-none ms-2" title="How to use?">
                            <small>❓</small>
                        </a>
                    </h5>
                    <div>
                        {% if prev_id %}
                        <a href="/annotate/{{ sheet_name }}/{{ prev_id }}"
                            class="btn btn-outline-secondary btn-sm">&larr; Prev</a>
                        {% endif %}
                        {% if next_id %}
                        <a href="/annotate/{{ sheet_name }}/{{ next_id }}" class="btn btn-outline-secondary btn-sm"
                            id="nextItemBtn">Next &rarr;</a>
                        {% endif %}
                    </div>
                </div>

                <div class="mb-2">
                    <small class="text-muted mb-0">Annotate each panel independently: male and female are side by side.</small>
                </div>
            </div>
        </div>

        <!-- Comparison Container -->
        <div class="row">

            <!-- Primary Panel -->
            <div class="{{ 'col-md-6' if peer_sheet_name else 'col-md-12' }}">
                <div class="card audio-card fade-up" id="primaryPanelCard">
                    <div class="card-header">
                        <div class="panel-header">
                            <h5 class="mb-0">{{ 'Male' if 'Male' in sheet_name else 'Female' if 'Female' in sheet_name else
                                sheet_name }} (Current)</h5>
                            <span class="panel-chip">Primary</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <audio controls class="w-100 mb-2" id="primaryAudio">
                            <source src="/audio/{{ sheet_name }}/{{ item_id }}.wav" type="audio/wav">
                            Your browser does not support the audio element.
                        </audio>
                        <div class="mb-3">
                            <small class="text-muted d-block mb-1">Transcript (Primary): click incorrect words</small>
                            <div id="interactive-text-primary" class="interactive-text"></div>
                            <small class="text-muted" id="selectionMetaPrimary"></small>
                        </div>
                        <button type="button" class="btn btn-success w-100 mb-3" onclick="fillPerfect('form_primary')">
                            ✨ Perfect (Human-like, Intelligibility: Yes, Context: N/A)
                        </button>

                        <!-- Form Primary -->
                        <form id="form_primary" data-sheet="{{ sheet_name }}">
                            <div class="mb-3">
                                <label class="form-label d-block">Naturalness: Does it sound robotic or human?</label>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="Naturalness"
                                        id="primary_nat_human" value="Human-like" {% if
                                        existing_data.get('Naturalness')=='Human-like' %}checked{% endif %} required>
                                    <label class="form-check-label" for="primary_nat_human">Human-like</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="Naturalness"
                                        id="primary_nat_slightly" value="Slightly Robotic" {% if
                                        existing_data.get('Naturalness')=='Slightly Robotic' %}checked{% endif %}>
                                    <label class="form-check-label" for="primary_nat_slightly">Slightly Robotic</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="Naturalness"
                                        id="primary_nat_robotic" value="Very Robotic" {% if
                                        existing_data.get('Naturalness')=='Very Robotic' %}checked{% endif %}>
                                    <label class="form-check-label" for="primary_nat_robotic">Very Robotic</label>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label d-block">Intelligibility: Can you understand every word
                                        clearly?</label>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="Intelligibility"
                                            id="primary_int_yes" value="Yes" {% if
                                            existing_data.get('Intelligibility')=='Yes' %}checked{% endif %}>
                                        <label class="form-check-label" for="primary_int_yes">Yes</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="Intelligibility"
                                            id="primary_int_mostly" value="Mostly" {% if
                                            existing_data.get('Intelligibility')=='Mostly' %}checked{% endif %}>
                                        <label class="form-check-label" for="primary_int_mostly">Mostly</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="Intelligibility"
                                            id="primary_int_barely" value="Barely" {% if
                                            existing_data.get('Intelligibility')=='Barely' %}checked{% endif %}>
                                        <label class="form-check-label" for="primary_int_barely">Barely</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="Intelligibility"
                                            id="primary_int_no" value="No" {% if
                                            existing_data.get('Intelligibility')=='No' %}checked{% endif %}>
                                        <label class="form-check-label" for="primary_int_no">No</label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label d-block">Context: Did it get the question/sarcasm tone
                                        right?</label>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="Context" id="primary_ctx_yes"
                                            value="Yes" {% if existing_data.get('Context')=='Yes' %}checked{% endif %}>
                                        <label class="form-check-label" for="primary_ctx_yes">Yes</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="Context" id="primary_ctx_no"
                                            value="No" {% if existing_data.get('Context')=='No' %}checked{% endif %}>
                                        <label class="form-check-label" for="primary_ctx_no">No</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="Context" id="primary_ctx_na"
                                            value="Not Applicable" {% if existing_data.get('Context')=='Not Applicable'
                                            %}checked{% endif %}>
                                        <label class="form-check-label" for="primary_ctx_na">Not Applicable</label>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">List of IncorrectWords</label>
                                <textarea class="form-control" name="IncorrectWords" id="primary_incorrectWordsInput"
                                    rows="2" readonly>{{ existing_data.get('IncorrectWords', '') }}</textarea>
                                <button type="button" class="btn btn-sm btn-outline-secondary mt-1"
                                    id="primary_clearWordsBtn">Clear
                                    Selection</button>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">List of Mistakes regarding Numbers (সংখ্যা)</label>
                                    <input type="text" class="form-control" name="NumberMistakes"
                                        value="{{ existing_data.get('NumberMistakes', '') }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">List of Conjunct Mistakes (যুক্তাক্ষর)</label>
                                    <input type="text" class="form-control" name="ConjunctMistakes"
                                        value="{{ existing_data.get('ConjunctMistakes', '') }}">
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Notes</label>
                                <textarea class="form-control" name="Notes"
                                    rows="2">{{ existing_data.get('Notes', '') }}</textarea>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            {% if peer_sheet_name %}
            <!-- Peer Panel -->
            <div class="col-md-6">
                <div class="card audio-card fade-up" id="peerPanelCard">
                    <div class="card-header">
                        <div class="panel-header">
                            <h5 class="mb-0">{{ 'Male' if 'Male' in peer_sheet_name else 'Female' if 'Female' in
                                peer_sheet_name else peer_sheet_name }}</h5>
                            <span class="panel-chip">Peer</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <audio controls class="w-100 mb-2" id="peerAudio">
                            <source src="/audio/{{ peer_sheet_name }}/{{ item_id }}.wav" type="audio/wav">
                            Your browser does not support the audio element.
                        </audio>
                        <div class="mb-3">
                            <small class="text-muted d-block mb-1">Transcript (Peer): click incorrect words</small>
                            <div id="interactive-text-peer" class="interactive-text"></div>
                            <small class="text-muted" id="selectionMetaPeer"></small>
                        </div>
                        <button type="button" class="btn btn-success w-100 mb-3" onclick="fillPerfect('form_peer')">
                            ✨ Perfect (Human-like, Intelligibility: Yes, Context: N/A)
                        </button>

                        <!-- Form Peer -->
                        <form id="form_peer" data-sheet="{{ peer_sheet_name }}">
                            <div class="mb-3">
                                <label class="form-label d-block">Naturalness: Does it sound robotic or human?</label>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="Naturalness" id="peer_nat_human"
                                        value="Human-like" {% if peer_data.get('Naturalness')=='Human-like' %}checked{%
                                        endif %} required>
                                    <label class="form-check-label" for="peer_nat_human">Human-like</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="Naturalness"
                                        id="peer_nat_slightly" value="Slightly Robotic" {% if
                                        peer_data.get('Naturalness')=='Slightly Robotic' %}checked{% endif %}>
                                    <label class="form-check-label" for="peer_nat_slightly">Slightly Robotic</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="Naturalness"
                                        id="peer_nat_robotic" value="Very Robotic" {% if
                                        peer_data.get('Naturalness')=='Very Robotic' %}checked{% endif %}>
                                    <label class="form-check-label" for="peer_nat_robotic">Very Robotic</label>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label d-block">Intelligibility: Can you understand every word
                                        clearly?</label>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="Intelligibility"
                                            id="peer_int_yes" value="Yes" {% if peer_data.get('Intelligibility')=='Yes'
                                            %}checked{% endif %}>
                                        <label class="form-check-label" for="peer_int_yes">Yes</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="Intelligibility"
                                            id="peer_int_mostly" value="Mostly" {% if
                                            peer_data.get('Intelligibility')=='Mostly' %}checked{% endif %}>
                                        <label class="form-check-label" for="peer_int_mostly">Mostly</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="Intelligibility"
                                            id="peer_int_barely" value="Barely" {% if
                                            peer_data.get('Intelligibility')=='Barely' %}checked{% endif %}>
                                        <label class="form-check-label" for="peer_int_barely">Barely</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="Intelligibility"
                                            id="peer_int_no" value="No" {% if peer_data.get('Intelligibility')=='No'
                                            %}checked{% endif %}>
                                        <label class="form-check-label" for="peer_int_no">No</label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label d-block">Context: Did it get the question/sarcasm tone
                                        right?</label>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="Context" id="peer_ctx_yes"
                                            value="Yes" {% if peer_data.get('Context')=='Yes' %}checked{% endif %}>
                                        <label class="form-check-label" for="peer_ctx_yes">Yes</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="Context" id="peer_ctx_no"
                                            value="No" {% if peer_data.get('Context')=='No' %}checked{% endif %}>
                                        <label class="form-check-label" for="peer_ctx_no">No</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="Context" id="peer_ctx_na"
                                            value="Not Applicable" {% if peer_data.get('Context')=='Not Applicable'
                                            %}checked{% endif %}>
                                        <label class="form-check-label" for="peer_ctx_na">Not Applicable</label>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">List of IncorrectWords</label>
                                <textarea class="form-control" name="IncorrectWords" id="peer_incorrectWordsInput"
                                    rows="2" readonly>{{ peer_data.get('IncorrectWords', '') }}</textarea>
                                <button type="button" class="btn btn-sm btn-outline-secondary mt-1"
                                    id="peer_clearWordsBtn">Clear
                                    Selection</button>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">List of Mistakes regarding Numbers (সংখ্যা)</label>
                                    <input type="text" class="form-control" name="NumberMistakes"
                                        value="{{ peer_data.get('NumberMistakes', '') }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">List of Conjunct Mistakes (যুক্তাক্ষর)</label>
                                    <input type="text" class="form-control" name="ConjunctMistakes"
                                        value="{{ peer_data.get('ConjunctMistakes', '') }}">
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Notes</label>
                                <textarea class="form-control" name="Notes"
                                    rows="2">{{ peer_data.get('Notes', '') }}</textarea>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Comparison Preference -->
        {% if peer_sheet_name %}
        <div class="card mt-4 mb-5 preference-card fade-up">
            <div class="card-header">
                <h5 class="mb-0">Overall Preference</h5>
            </div>
            <div class="card-body text-center">
                <p class="lead">Which version sounded better?</p>
                <div class="btn-group" role="group" aria-label="Preference Selection">
                    <input type="radio" class="btn-check" name="preference" id="pref_primary" value="{{ sheet_name }}"
                        autocomplete="off" {% if existing_data.get('Preference')==sheet_name %}checked{% endif %}>
                    <label class="btn btn-outline-primary btn-lg" for="pref_primary">{{ 'Male' if 'Male' in sheet_name
                        else 'Female' if 'Female' in sheet_name else sheet_name }}</label>

                    <input type="radio" class="btn-check" name="preference" id="pref_neutral" value="Equal"
                        autocomplete="off" {% if existing_data.get('Preference')=='Equal' %}checked{% endif %}>
                    <label class="btn btn-outline-secondary btn-lg" for="pref_neutral">No Difference / Equal</label>

                    <input type="radio" class="btn-check" name="preference" id="pref_peer" value="{{ peer_sheet_name }}"
                        autocomplete="off" {% if existing_data.get('Preference')==peer_sheet_name %}checked{% endif %}>
                    <label class="btn btn-outline-secondary btn-lg" for="pref_peer">{{ 'Male' if 'Male' in
                        peer_sheet_name else 'Female' if 'Female' in peer_sheet_name else peer_sheet_name }}</label>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Global Action Bar -->
        <div class="fixed-action-bar">
            <div class="container-xxl action-shell d-flex justify-content-between align-items-center">
                <div class="text-start small text-muted">
                    Save will record your preference in both files.
                </div>
                <button type="button" class="btn btn-primary btn-lg" id="saveAllBtn">Save All & Next</button>
            </div>
        </div>
        <div style="height: 100px;"></div> <!-- Spacer -->

    </div>
</div>

<script>
    const rawText = {{ text | tojson }};
    const existingIncorrectPrimary = {{ existing_data.get('IncorrectWords', '') | tojson }};
    const existingIncorrectPeer = {{ peer_data.get('IncorrectWords', '') | tojson }};
    const existingPreference = {{ existing_data.get('Preference', '') | tojson }};

    const hasExistingDataPrimary = {{ 'true' if existing_data else 'false' }};
    const hasExistingDataPeer = {{ 'true' if peer_data else 'false' }};
    const hasPeer = {{ 'true' if peer_sheet_name else 'false' }};

    const primaryInput = document.getElementById('primary_incorrectWordsInput');
    const peerInput = document.getElementById('peer_incorrectWordsInput');
    const words = rawText.split(/\s+/).filter(w => w.length > 0);

    let activePanel = 'primary';
    let isDirty = false;
    const selectedWordIndexes = { primary: new Set(), peer: new Set() };
    const panelConfig = {
        primary: {
            label: 'Primary',
            container: document.getElementById('interactive-text-primary'),
            selectionMeta: document.getElementById('selectionMetaPrimary'),
            card: document.getElementById('primaryPanelCard'),
            input: primaryInput
        },
        peer: {
            label: 'Peer',
            container: document.getElementById('interactive-text-peer'),
            selectionMeta: document.getElementById('selectionMetaPeer'),
            card: document.getElementById('peerPanelCard'),
            input: peerInput
        }
    };

    function markDirty() {
        isDirty = true;
    }

    function sanitizeToken(token) {
        return token
            .replace(/^[\p{P}\p{S}"'“”‘’]+|[\p{P}\p{S}"'“”‘’]+$/gu, '')
            .trim()
            .toLowerCase();
    }

    function parseSavedWords(value) {
        if (!value) return [];
        const commaSplit = value.split(',').map(v => v.trim()).filter(Boolean);
        if (commaSplit.length > 1) return commaSplit;
        return value.split(/\s+/).map(v => v.trim()).filter(Boolean);
    }

    function hydrateSelectionFromSaved(panel, savedValue) {
        const savedWords = parseSavedWords(savedValue);
        const usedIndexes = new Set();

        savedWords.forEach(savedWord => {
            const target = sanitizeToken(savedWord);
            for (let idx = 0; idx < words.length; idx += 1) {
                if (usedIndexes.has(idx)) continue;
                if (sanitizeToken(words[idx]) === target) {
                    selectedWordIndexes[panel].add(idx);
                    usedIndexes.add(idx);
                    break;
                }
            }
        });
    }

    function serializeSelection(panel) {
        return Array
            .from(selectedWordIndexes[panel])
            .sort((a, b) => a - b)
            .map(idx => words[idx])
            .join(', ');
    }

    function updateIncorrectWordsInput(panel) {
        const value = serializeSelection(panel);
        const input = panelConfig[panel].input;
        if (input) input.value = value;
    }

    function updateSelectionMeta(panel) {
        const cfg = panelConfig[panel];
        if (!cfg.selectionMeta) return;
        const count = selectedWordIndexes[panel].size;
        cfg.selectionMeta.textContent = `${cfg.label}: ${count} incorrect word(s) selected`;
    }

    function toggleWord(panel, index) {
        const activeSet = selectedWordIndexes[panel];
        if (activeSet.has(index)) {
            activeSet.delete(index);
        } else {
            activeSet.add(index);
        }
        updateIncorrectWordsInput(panel);
        renderText(panel);
        updateSelectionMeta(panel);
        markDirty();
    }

    function renderText(panel) {
        const cfg = panelConfig[panel];
        if (!cfg.container) return;
        const activeSet = selectedWordIndexes[panel];
        cfg.container.innerHTML = '';
        words.forEach((word, index) => {
            const span = document.createElement('span');
            span.className = 'word-token';
            span.textContent = word;
            span.setAttribute('role', 'button');
            span.setAttribute('tabindex', '0');
            span.setAttribute('aria-pressed', activeSet.has(index) ? 'true' : 'false');
            span.setAttribute('aria-label', `${panel} ${word} (${index + 1})`);

            if (activeSet.has(index)) {
                span.classList.add('selected');
            }

            span.addEventListener('click', () => {
                setActivePanel(panel);
                toggleWord(panel, index);
            });
            span.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    setActivePanel(panel);
                    toggleWord(panel, index);
                }
            });

            cfg.container.appendChild(span);
            cfg.container.appendChild(document.createTextNode(' '));
        });
    }

    function setActivePanel(panel) {
        activePanel = panel;
        if (panelConfig.primary.card) panelConfig.primary.card.classList.toggle('active-target', panel === 'primary');
        if (panelConfig.peer.card) panelConfig.peer.card.classList.toggle('active-target', panel === 'peer');
    }

    const primarySheetName = {{ sheet_name | tojson }};
    const peerSheetName = {{ (peer_sheet_name or '') | tojson }};

    function setRadioValue(formId, fieldName, value, shouldMarkDirty = false) {
        const field = document.querySelector(`#${formId} input[name="${fieldName}"][value="${value}"]`);
        if (field) {
            field.checked = true;
            if (shouldMarkDirty) {
                markDirty();
            }
        }
    }

    function togglePlayPauseForPanel(panel) {
        const audioId = panel === 'primary' ? 'primaryAudio' : 'peerAudio';
        const audio = document.getElementById(audioId);
        if (!audio) return;
        if (audio.paused) {
            audio.play();
        } else {
            audio.pause();
        }
    }

    function setPreference(value, shouldMarkDirty = true) {
        const target = document.querySelector(`input[name="preference"][value="${value}"]`);
        if (target) {
            target.checked = true;
            if (shouldMarkDirty) {
                markDirty();
            }
        }
    }

    function validateForm(annotationData, sheetName) {
        if (!annotationData.Naturalness) {
            alert(`Please select a Naturalness rating for ${sheetName}.`);
            return false;
        }
        if (!annotationData.Intelligibility) {
            alert(`Please select an Intelligibility rating for ${sheetName}.`);
            return false;
        }
        if (!annotationData.Context) {
            alert(`Please select a Context rating for ${sheetName}.`);
            return false;
        }
        return true;
    }

    hydrateSelectionFromSaved('primary', existingIncorrectPrimary);
    if (hasPeer) hydrateSelectionFromSaved('peer', existingIncorrectPeer);
    updateIncorrectWordsInput('primary');
    updateSelectionMeta('primary');
    renderText('primary');
    if (hasPeer) {
        updateIncorrectWordsInput('peer');
        updateSelectionMeta('peer');
        renderText('peer');
    }

    document.getElementById('primary_clearWordsBtn').addEventListener('click', () => {
        selectedWordIndexes.primary.clear();
        updateIncorrectWordsInput('primary');
        renderText('primary');
        updateSelectionMeta('primary');
        setActivePanel('primary');
        markDirty();
    });

    const peerClearBtn = document.getElementById('peer_clearWordsBtn');
    if (peerClearBtn) {
        peerClearBtn.addEventListener('click', () => {
            selectedWordIndexes.peer.clear();
            updateIncorrectWordsInput('peer');
            renderText('peer');
            updateSelectionMeta('peer');
            setActivePanel('peer');
            markDirty();
        });
    }

    panelConfig.primary.card.addEventListener('click', () => setActivePanel('primary'));
    if (hasPeer && panelConfig.peer.card) panelConfig.peer.card.addEventListener('click', () => setActivePanel('peer'));

    function applyDefaultContext(formId, hasExisting) {
        if (!hasExisting) {
            if (rawText.includes('?')) {
                setRadioValue(formId, 'Context', 'No');
            } else {
                setRadioValue(formId, 'Context', 'Not Applicable');
            }
        }
    }

    applyDefaultContext('form_primary', hasExistingDataPrimary);
    if (document.getElementById('form_peer')) {
        applyDefaultContext('form_peer', hasExistingDataPeer);
    }

    if (existingPreference) {
        setPreference(existingPreference, false);
    }

    function fillPerfect(formId) {
        const form = document.getElementById(formId);
        const panel = formId === 'form_primary' ? 'primary' : 'peer';
        form.querySelector(`input[name="Naturalness"][value="Human-like"]`).checked = true;
        form.querySelector(`input[name="Intelligibility"][value="Yes"]`).checked = true;
        form.querySelector(`input[name="Context"][value="Not Applicable"]`).checked = true;

        selectedWordIndexes[panel].clear();
        updateIncorrectWordsInput(panel);
        renderText(panel);
        updateSelectionMeta(panel);
        setActivePanel(panel);

        form.querySelector(`input[name="NumberMistakes"]`).value = '';
        form.querySelector(`input[name="ConjunctMistakes"]`).value = '';
        form.querySelector(`textarea[name="Notes"]`).value = '';
        markDirty();
    }

    const formsToWatch = ['form_primary', 'form_peer'];
    formsToWatch.forEach((formId) => {
        const form = document.getElementById(formId);
        if (!form) return;
        form.addEventListener('input', markDirty);
        form.addEventListener('change', markDirty);
    });

    const prefInputs = document.querySelectorAll('input[name="preference"]');
    prefInputs.forEach((input) => input.addEventListener('change', markDirty));

    window.addEventListener('beforeunload', (event) => {
        if (!isDirty) return;
        event.preventDefault();
        event.returnValue = '';
    });

    window.onload = function () {
        const activeItem = document.querySelector('.list-group-item.active');
        if (activeItem) {
            activeItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    };

    setActivePanel('primary');

    document.addEventListener('keydown', (event) => {
        const target = event.target;
        const tag = target && target.tagName ? target.tagName.toLowerCase() : '';
        const isTyping = tag === 'input' || tag === 'textarea' || tag === 'select' || (target && target.isContentEditable);
        if (isTyping) return;

        if (event.code === 'Space') {
            event.preventDefault();
            togglePlayPauseForPanel(activePanel);
            return;
        }

        if (event.key === 'Enter') {
            event.preventDefault();
            document.getElementById('saveAllBtn').click();
            return;
        }

        if (event.key === '1') setRadioValue(`form_${activePanel}`, 'Naturalness', 'Human-like', true);
        if (event.key === '2') setRadioValue(`form_${activePanel}`, 'Naturalness', 'Slightly Robotic', true);
        if (event.key === '3') setRadioValue(`form_${activePanel}`, 'Naturalness', 'Very Robotic', true);

        if (hasPeer && event.key === '[') setActivePanel('primary');
        if (hasPeer && event.key === ']') setActivePanel('peer');

        if (hasPeer && event.key.toLowerCase() === 'y') setPreference(primarySheetName);
        if (hasPeer && event.key.toLowerCase() === 'n') setPreference(peerSheetName);
        if (hasPeer && event.key.toLowerCase() === 'e') setPreference('Equal');
    });

    document.getElementById('saveAllBtn').addEventListener('click', function (e) {
        e.preventDefault();

        const formsToSubmit = ['form_primary'];
        if (document.getElementById('form_peer')) {
            formsToSubmit.push('form_peer');
        }

        const allAnnotations = [];

        let preference = null;
        if (document.getElementById('form_peer')) {
            const prefEl = document.querySelector('input[name="preference"]:checked');
            if (prefEl) {
                preference = prefEl.value;
            } else {
                alert("Please select which version is better (or if they are equal).");
                return;
            }
        }

        for (const formId of formsToSubmit) {
            const form = document.getElementById(formId);
            const formData = new FormData(form);
            const annotationData = Object.fromEntries(formData.entries());
            const sheetName = form.dataset.sheet;

            if (!validateForm(annotationData, sheetName)) {
                return;
            }

            if (preference) {
                annotationData.Preference = preference;
            }

            allAnnotations.push({
                sheet_name: sheetName,
                item_id: '{{ item_id }}',
                annotation: annotationData
            });
        }

        const btn = this;
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = "Saving...";

        fetch('/api/save_multiple', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(allAnnotations),
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    isDirty = false;
                    btn.innerText = "Saved!";

                    const activeSidebarItem = document.querySelector('.list-group-item.active');
                    if (activeSidebarItem && !activeSidebarItem.querySelector('.text-success')) {
                        const badge = document.createElement('span');
                        badge.className = 'text-success';
                        badge.innerHTML = '&check;';
                        activeSidebarItem.querySelector('div').appendChild(badge);
                    }

                    setTimeout(() => {
                        const nextBtn = document.getElementById('nextItemBtn');
                        if (nextBtn) {
                            window.location.href = nextBtn.href;
                        } else {
                            btn.disabled = false;
                            btn.innerText = "Saved (Last Item)";
                        }
                    }, 300);
                } else {
                    alert('Error saving: ' + (data.message || 'Unknown error'));
                    btn.disabled = false;
                    btn.innerText = originalText;
                }
            })
            .catch(() => {
                alert('Network error or server issue.');
                btn.disabled = false;
                btn.innerText = originalText;
            });
    });
</script>
{% endblock %}
